%% Solve model 

fprintf('=============================\n')
fprintf('Solving the model...\n')
fprintf('=============================\n')

%Allocate arrays
J0 = zeros(n_w, n_z);
W0 = zeros(n_w, n_z);
U0 = zeros(n_w, n_z);
J = zeros(n_w, n_z);
W = zeros(n_w, n_z);
U = zeros(n_w, n_z);
value_search = zeros(n_w, n_z);
search_UI = zeros(n_w, n_z);
search_low = zeros(1, n_z);
RHS = zeros(n_s, n_z);
policy_wage = zeros(n_w, n_z);
idx_wage = zeros(n_w, n_z);
policy_effort = zeros(n_w, n_z);

U0=[-43.1191846355250,-42.8236747356421,-42.4237345592410,-41.9281862484405,-41.2814208588472,-40.6618447659050,-40.0908990009086,-39.4747641949140,-38.8026255324701,-38.1024046469551,-37.3858552560369,-36.7118890972189,-36.0320675232961,-35.4273063814739,-35.0126813994102;-43.0750107273001,-42.7808984048787,-42.3823952297846,-41.8870961671169,-41.2388523826047,-40.6205905028270,-40.0503867386006,-39.4327491648089,-38.7606706695786,-38.0592510690115,-37.3437751144680,-36.6711456919891,-35.9905981727268,-35.3864851977615,-34.9729887686207;-43.0308363556484,-42.7381207128281,-42.3410511578029,-41.8459877671593,-41.1962114298147,-40.5790342305816,-40.0095710153760,-39.3906765571052,-38.7187035864474,-38.0160946876526,-37.3016942843621,-36.6304021177377,-35.9491287778214,-35.3456640016121,-34.9332961340528;-42.9865867356012,-42.6953318191135,-42.2997001702910,-41.8048569629674,-41.1535643393096,-40.5374660476628,-39.9687031978476,-39.3483495968252,-38.6766837257548,-37.9729261919921,-37.2596104789417,-36.5896578131077,-35.9076591913297,-35.3048427517198,-34.8936034831581;-42.9420155601169,-42.6523981172953,-42.2581512203292,-41.7633853359752,-41.1108635417329,-40.4958853114919,-39.9278185665504,-39.3059481115215,-38.6346483998434,-37.9297541465297,-37.2175258016776,-36.5489132944580,-35.8661895486984,-35.2640214860793,-34.8539108274792;-42.8973261554547,-42.6091140426796,-42.2163230909127,-41.7218742406720,-41.0681559736125,-40.4543013505109,-39.8869239421585,-39.2634997159942,-38.5923733266369,-37.8865284030777,-37.1754279286222,-36.5081655365576,-35.8247190563761,-35.2231999820870,-34.8142180993901;-42.8526367494520,-42.5658299641696,-42.1744949480855,-41.6803630942065,-41.0254482053307,-40.4127165718501,-39.8460255609184,-39.2210333497588,-38.5500063377859,-37.8432820726101,-37.1333249964954,-36.4674165367762,-35.7832482382950,-35.1823783867141,-34.7745253435399;-42.8079473428036,-42.5225458837838,-42.1326667987984,-41.6388519230959,-40.9827403406300,-40.3711313993086,-39.8051253700080,-39.1785583225112,-38.5075960688714,-37.7998050547420,-37.0904845755338,-36.4242703639519,-35.7404728249152,-35.1404860167944,-34.7313952159522;-42.7632563053873,-42.4792570659604,-42.0908223347638,-41.5972785483637,-40.9397834777240,-40.3295031478892,-39.7642153668124,-39.1360711312829,-38.4651321332801,-37.7560416517481,-37.0472352011739,-36.3799216737032,-35.6970868748334,-35.0983889546809,-34.6880557679151;-42.7185513753527,-42.4359278889187,-42.0488389741820,-41.5554167392172,-40.8966480560794,-40.2878229222090,-39.7232088858887,-39.0935654477712,-38.4226642291379,-37.7122773282802,-37.0039855994087,-36.3355729231366,-35.6537009077403,-35.0562918877682,-34.6447163183015;-42.6736122439501,-42.3919183368012,-42.0045141678279,-41.5088760439323,-40.8519790945044,-40.2454870762899,-39.6818351085680,-39.0509868109945,-38.3801699302584,-37.6684502474126,-36.9603964485441,-36.2910769171154,-35.6102737876410,-35.0141832080158,-34.6013730539136;-42.6286713811886,-42.3479037549376,-41.9601720520749,-41.4622738443773,-40.8072986149305,-40.2031456811557,-39.6404443381633,-39.0083276067644,-38.3376572537216,-37.6246111559168,-36.9167609577071,-36.2463182320500,-35.5667742348794,-34.9720540816617,-34.5580230729568;-42.5833665704002,-42.3037271672097,-41.9155448850918,-41.4153473415779,-40.7625590055527,-40.1607821915837,-39.5989965940936,-38.9654012903115,-38.2950885191568,-37.5807590490480,-36.8731222165946,-36.2015586760389,-35.5232744365451,-34.9299248860258,-34.5146730692410;-42.5378729727527,-42.2591673839477,-41.8706947092673,-41.3683854141200,-40.7178127532559,-40.1184159418637,-39.5575411275247,-38.9224393620705,-38.2523400234379,-37.5368657810544,-36.8294708310806,-36.1567816585254,-35.4796779993327,-34.8877690925663,-34.4713143222095;-42.4923793717460,-42.2146075910394,-41.8258445006250,-41.3214233736990,-40.6730661062534,-40.0760481124101,-39.5160784967559,-38.8794435633147,-38.2094203778856,-37.4929327145485,-36.7858038512631,-36.1119667658922,-35.4358512840123,-34.8455499275360,-34.4279347434161;-42.4468857707387,-42.1700477981289,-41.7809942919753,-41.2744613332521,-40.6283194591603,-40.0336802825942,-39.4746158643441,-38.8364477567870,-38.1665006939432,-37.4489994476074,-36.7421357502535,-36.0671451818839,-35.3919819763284,-34.8030119241466,-34.3844532227193;-42.4013907684581,-42.1254839810898,-41.7361303925492,-41.2274521903235,-40.5834044968312,-39.9912829365679,-39.4331462240655,-38.7934425884285,-38.1235397073855,-37.4048471682317,-36.6984139654338,-36.0223081565135,-35.3481016330081,-34.7604216918882,-34.3406442735793;-42.3558938499790,-42.0809146611768,-41.6912477714367,-41.1803786315246,-40.5382601278835,-39.9487144362511,-39.3913990279883,-38.7503788813401,-38.0805431695261,-37.3605647840945,-36.6546603696193,-35.9774625426566,-35.3042184858742,-34.7178280305570,-34.2968132686346;-42.3103962661923,-42.0363434306556,-41.6463586501894,-41.1332826982924,-40.4930375975584,-39.9058300084977,-39.3494832178984,-38.7072807022358,-38.0375315474610,-37.3162392215615,-36.6106716422701,-35.9325553814574,-35.2603177964716,-34.6752293655760,-34.2529806013580;-42.2648937892675,-41.9917581570887,-41.6014205398203,-41.0861789235020,-40.4478132652765,-39.8629436513408,-39.3075598329112,-38.6641465872296,-37.9945079606351,-37.2718882715470,-36.5665492033188,-35.8875050850938,-35.2163770405797,-34.6326192670545,-34.2091441356332;-42.2188905542881,-41.9467761943087,-41.5560212490258,-41.0387294024454,-40.4025245104921,-39.8200309022132,-39.2655648226413,-38.6206795790117,-37.9514124287209,-37.2275138741862,-36.5223846493950,-35.8422252425427,-35.1723723344657,-34.5899909172139,-34.1653016064794;-42.1728015456129,-41.9016181588057,-41.5105724580953,-40.9911857082695,-40.3572186805989,-39.7771127571472,-39.2235583022036,-38.5771612132518,-37.9080611363522,-37.1830808198029,-36.4782052780431,-35.7969413856077,-35.1283664850765,-34.5473622412660,-34.1214589689850;-42.1267125344341,-41.8564601161984,-41.4651236432966,-40.9436419328449,-40.3119125699424,-39.7341935018483,-39.1815468124865,-38.5336196383615,-37.8645940359128,-37.1386198555499,-36.4340113991480,-35.7516095989796,-35.0840633861522,-34.5046508391606,-34.0775888294128;-42.0806235232535,-41.8113020735860,-41.4196748284803,-40.8960981573605,-40.2666064590790,-39.6912742457316,-39.1395353191091,-38.4900780463675,-37.8211268520183,-37.0941584606271,-36.3898151383917,-35.7062637523717,-35.0396707575182,-34.4616090280260,-34.0336116982888;-42.0345321956429,-41.7661374580484,-41.3742039299661,-40.8484792394397,-40.2210355780440,-39.6481882009878,-39.0971242422677,-38.4464166572731,-37.7776097707041,-37.0495610206432,-36.3455850898710,-35.6609079002809,-34.9952699417485,-34.4185255735018,-33.9895403316340;-41.9884341336424,-41.7209537335147,-41.3286688296133,-40.8006417970236,-40.1747060750311,-39.6027032722032,-39.0496034107735,-38.3997829243300,-37.7305814341225,-37.0032908398167,-36.3009336815380,-35.6154370848559,-34.9508313434029,-34.3753970946562,-33.9451853923191;-41.9423308036998,-41.6757550698831,-41.2830823377491,-40.7527886949292,-40.1283481304903,-39.5571108522055,-39.0019263292101,-38.3525526125308,-37.6819901380057,-36.9562912323994,-36.2558270473708,-35.5698446738316,-34.9063577334359,-34.3322585147377,-33.9008270577533;-41.8959346423666,-41.6302440976774,-41.2371001792826,-40.7048717258693,-40.0819766103135,-39.5115078635645,-38.9542143930286,-38.3051750328353,-37.6333608062680,-36.9092661595709,-36.2106261507007,-35.5242272943271,-34.8618769327866,-34.2891178602721,-33.8564680258745;-41.8492053269213,-41.5844379933846,-41.1909865015339,-40.6566268044711,-40.0355435166905,-39.4658798056120,-38.9064414732493,-38.2575454879836,-37.5846700763415,-36.8622157461329,-36.1653664605003,-35.4782820430167,-34.8173038159956,-34.2459505570677,-33.8121000367493;-41.8024734908138,-41.5386248255591,-41.1448494126016,-40.6083014873879,-39.9890952058929,-39.4202450780520,-38.8586514623170,-38.2098465026615,-37.5356665060337,-36.8150855262342,-36.1200806061357,-35.4322952206162,-34.7727189609172,-34.2027798656373,-33.7677309087622;-41.7557416523897,-41.4928116512423,-41.0987123021437,-40.5599760978790,-39.9426466477008,-39.3746093845194,-38.8108575308304,-38.1621311084795,-37.4865889155816,-36.7679309053004,-36.0747570275835,-35.3861142622918,-34.7269265646015,-34.1560678416518,-33.7211468286996;-41.7090087741215,-41.4469955630571,-41.0525655289606,-40.5116182120019,-39.8960846318793,-39.3289533860752,-38.7630594473347,-38.1144147466148,-37.4375109151126,-36.7207753656492,-36.0294287686105,-35.3399060739855,-34.6809633867948,-34.1087844266472,-33.6742898440688;-41.6622720529327,-41.4011687061744,-41.0063830456439,-40.4631402152393,-39.8491057588602,-39.2828020814628,-38.7148414065632,-38.0665968909623,-37.3883683485187,-36.6734135674028,-35.9840489098039,-35.2936837269380,-34.6349960640865,-34.0614997096489,-33.6274323913973;-41.6155117595312,-41.3552758342132,-40.9599762965483,-40.4146196708684,-39.8020977848265,-39.2365611117023,-38.6665275194098,-38.0187481258555,-37.3391748617908,-36.6258327562557,-35.9384850567064,-35.2474106069061,-34.5890066605311,-34.0141598585872,-33.5802067990980;-41.5684488915376,-41.3089883918266,-40.9133002601120,-40.3660553188426,-39.7550814843034,-39.1903172959725,-38.6182078286984,-37.9708761186569,-37.2899660186329,-36.5782023378495,-35.8926565577750,-35.2010665027117,-34.5429960211543,-33.9668103667943,-33.5329562757283;-41.5210403840303,-41.2625118567408,-40.8665599649240,-40.3173553974582,-39.7080350584485,-39.1440452731584,-38.5697919227509,-37.9226014589968,-37.2406612154513,-36.5305470218077,-35.8468216275703,-35.1547206351618,-34.4969848655418,-33.9194607127547,-33.4857056934031;-41.4736221404078,-41.2160083938984,-40.8197316353087,-40.2683568849697,-39.6609351709262,-39.0977633261927,-38.5213738369748,-37.8743257692816,-37.1913538114303,-36.4828800904032,-35.8009246609629,-35.1080099581238,-34.4508692191588,-33.8720782007776,-33.4384431716343];
W0=[-87.1929833937582,-87.0843552469598,-86.9296883955169,-86.7500683073739,-86.5553961088304,-86.3543368763098,-86.1496732149087,-85.9398166426435,-85.7242779504084,-85.5046948490382,-85.2840346580703,-85.0668121247304,-84.8585619799645,-84.6725343303819,-84.5394462303563;-85.5943270520071,-85.4858026283768,-85.3312260722927,-85.1516337029896,-84.9569575890240,-84.7559299954480,-84.5512641356121,-84.3413403376108,-84.1257393282121,-83.9061115577896,-83.6854856299537,-83.4683432311732,-83.2601552467704,-83.0742042322242,-82.9411984482593;-83.9956116064863,-83.8871866214134,-83.7326936807294,-83.5531203250078,-83.3584301057418,-83.1574264206382,-82.9527633043431,-82.7427880759582,-82.5271391757567,-82.3074774021171,-82.0868935054464,-81.8698369974323,-81.6617155010068,-81.4758443223892,-81.3429228849870;-82.3968642130855,-82.2885397038758,-82.1341293773867,-81.9545725395141,-81.7598649317472,-81.5588800877709,-81.3542129167259,-81.1441811701296,-80.9284899715459,-80.7088016799067,-80.4882659268066,-80.2712999885623,-80.0632485328310,-79.8774598259084,-79.7446244086848;-80.7980193393296,-80.6898037259540,-80.5354827735552,-80.3559526532125,-80.1612452484467,-79.9602913678081,-79.7556265176117,-79.5455419668771,-79.3298134837667,-79.1101031659700,-78.8896189821796,-78.6727461871577,-78.4647667150492,-78.2790619187692,-78.1463134349025;-79.1990895770248,-79.0909858428624,-78.9367675110931,-78.7572799714567,-78.5625811901506,-78.3616604244079,-78.1569956923924,-77.9468528618331,-77.7310817747291,-77.5113536767423,-77.2909276260234,-77.0741536134404,-76.8662505458391,-76.6806329716616,-76.5479735301079;-77.6001537586081,-77.4921614610589,-77.3380450522599,-77.1585991503476,-76.9639077392568,-76.7630184013210,-76.5583514924020,-76.3481473959868,-76.1323310913689,-75.9125864499401,-75.6922207706027,-75.4755474978623,-75.2677223762109,-75.0821931802770,-74.9496235176444;-76.0011626025561,-75.8932776964760,-75.7392568325273,-75.5598439393751,-75.3651483964175,-75.1642748571988,-74.9595838324294,-74.7492864403583,-74.5333763104651,-74.3135402987002,-74.0931259744722,-73.8764230195688,-73.6685971041047,-73.4830849459365,-73.3505009345065;-74.4021045240622,-74.2943222430750,-74.1403896695470,-73.9610011023277,-73.7662946827550,-73.5654371685261,-73.3607175095381,-73.1503135633436,-72.9342851461640,-72.7143202200774,-72.4938111078983,-72.2770282920923,-72.0691871077912,-71.8837003430444,-71.7511101747989;-72.8029750618752,-72.6952912584213,-72.5414426573618,-72.3620793850014,-72.1673723355844,-71.9665430946231,-71.7618040516463,-71.5513029201396,-71.3351636167094,-71.1150750878349,-70.8944750246822,-70.6776151841262,-70.4697608617117,-70.2843010660718,-70.1517057405023;-71.2029040704703,-71.0952679667780,-70.9414607267783,-70.7621777625686,-70.5676699146193,-70.3670503586053,-70.1624238944908,-69.9519199301643,-69.7357309605669,-69.5155546267077,-69.2948835448334,-69.0779693918654,-68.8701252963616,-68.6847117771700,-68.5521239582657;-69.6028132182559,-69.4952234959184,-69.3414558151262,-69.1622518690527,-68.9679434936080,-68.7675326923984,-68.5630162241404,-68.3525062338011,-68.1362662931755,-67.9159992034768,-67.6952503449537,-67.4782726668046,-67.2704382871448,-67.0850742824966,-66.9524967615352;-68.0025964664428,-67.8950614955626,-67.7413398547053,-67.5622263553483,-67.3681332334316,-67.1679396312430,-66.9635344884996,-66.7530184126104,-66.5367367923850,-66.3163891509897,-66.0955706127338,-65.8785355612748,-65.6707155602032,-65.4854045284945,-65.3528395013319;-66.4022952911157,-66.2948215121305,-66.1411620440823,-65.9621545566151,-65.7682849306285,-65.5683111066346,-65.3640160308229,-65.1534897667097,-64.9371621243237,-64.7167362682902,-64.4958513549488,-64.2787602538425,-64.0709539622065,-63.8856973703969,-63.7531467440603;-64.8019811247281,-64.6945675882460,-64.5409687965682,-64.3620652984826,-64.1684164800562,-63.9686588115266,-63.7644688560855,-63.5539258670188,-63.3375458431163,-63.1170416237867,-62.8960903212515,-62.6789396238768,-62.4711401837449,-62.2859376050173,-62.1534034359958;-63.2016659726493,-63.0943126066161,-62.9407743776968,-62.7619747152793,-62.5685464994874,-62.3690047078316,-62.1649194810683,-61.9543591920587,-61.7379258977413,-61.5173418561991,-61.2963216087281,-61.0791065606638,-60.8713049648218,-60.6861427148068,-60.5536198310464;-61.6013169792481,-61.4940214172941,-61.3405402390165,-61.1618405488392,-60.9686311625835,-60.7693090124312,-60.5653304252547,-60.3547511108611,-60.1382592665772,-59.9175890974418,-59.6965014312794,-59.4792252205532,-59.2714221565834,-59.0862957966032,-58.9537740284331;-60.0008963393258,-59.8936534909934,-59.7402216365117,-59.5616126792356,-59.3686144151244,-59.1695113729305,-58.9656433980756,-58.7550565297162,-58.5385150706513,-58.3177642432626,-58.0966170389214,-57.8792873283950,-57.6714888599138,-57.4864026589332,-57.3538842320407;-58.4004193214150,-58.2932251164709,-58.1398362720186,-57.9613099271972,-57.7685135434942,-57.5696234392401,-57.3658720596721,-57.1552872507884,-56.9387015935500,-56.7178698596711,-56.4966597663961,-56.2792805557071,-56.0714931377456,-55.8864527234632,-55.7539413856691;-56.7999274898424,-56.6927812204769,-56.5394350481074,-56.3609921676350,-56.1683975700378,-55.9697191097307,-55.7660819207621,-55.5554959557110,-55.3388628272065,-55.1179449322955,-54.8966646141004,-54.6792317908172,-54.4714567621316,-54.2864651019052,-54.1539631432821;-55.1992512061424,-55.0921655992222,-54.9388787168825,-54.7605416175325,-54.5681702716167,-54.3697136024798,-54.1661911209240,-53.9556020681564,-53.7389300636828,-53.5179339232364,-53.2965858086388,-53.0790976033152,-52.8713392241423,-52.6864026326409,-52.5539147094848;-53.5985212557763,-53.4914981411807,-53.3382756010581,-53.1600473182036,-52.9679021192796,-52.7696670187106,-52.5662555744046,-52.3556568052611,-52.1389397645994,-51.9178695526729,-51.6964604153162,-51.4789226972986,-51.2711855910673,-51.0863075413906,-50.9538358680265;-51.9977814451884,-51.8908201023239,-51.7376607685970,-51.5595397670393,-51.3676186741160,-51.1696023900342,-50.9662982159466,-50.7556846992250,-50.5389173914315,-50.3177714835762,-50.0962987192466,-49.8787046372963,-49.6709781532766,-49.4861567291698,-49.3537030954253;-50.3970403081582,-50.2901406400617,-50.1370443598432,-49.9590304327313,-49.7673331700431,-49.5695353275605,-49.3663378966359,-49.1557088587842,-48.9388900887103,-48.7176665270908,-48.4961267266396,-48.2784700614611,-48.0707432247606,-47.8859642492199,-47.7535235998715;-48.7962100728231,-48.6893657430654,-48.5363228787898,-48.3584044065723,-48.1669208182066,-47.9693386973336,-47.7662490874376,-47.5556179251077,-47.3387606788199,-47.1174684305170,-46.8958719869323,-46.6781618571533,-46.4704408864749,-46.2857071367175,-46.1532796378515;-47.1943413060937,-47.0874769114296,-46.9343695978464,-46.7563912406239,-46.5649296178410,-46.3673567774015,-46.1642360843736,-45.9536306775874,-45.7368317656998,-45.5156539594508,-45.2942076141856,-45.0766203723496,-44.8690418031869,-44.6844515232303,-44.5520933185067;-45.5923100013820,-45.4854140619457,-45.3322250148413,-45.1541648395483,-44.9626952487867,-44.7650919721584,-44.5618897244648,-44.3512477578505,-44.1344568606983,-43.9134011673490,-43.6921387120861,-43.4747172375386,-43.2673199679046,-43.0829036033835,-42.9506343584737;-43.9901704886503,-43.8832513608025,-43.7299955166100,-43.5518740785445,-43.3604086696047,-43.1627794758257,-42.9594954780103,-42.7488155418909,-42.5320355731722,-42.3111044790029,-42.0900269451068,-41.8727746503796,-41.6655626295354,-41.4813234476015,-41.3491453078286;-42.3879041372272,-42.2809703509362,-42.1276577109646,-41.9494825403504,-41.7580338860505,-41.5603848669216,-41.3570182188311,-41.1462974420979,-40.9295327254759,-40.7087290021445,-40.4878331815521,-40.2707424964514,-40.0637179866923,-39.8796621902137,-39.7475800301831;-40.7856037696416,-40.6786530295317,-40.5252803493588,-40.3470485656782,-40.1556153990744,-39.9579431147527,-39.7544872110376,-39.5437159949474,-39.3269578899584,-39.1062853641682,-38.8855781489680,-38.6686547365385,-38.4618231561133,-38.2779553249126,-38.1459721688082;-39.1832815735028,-39.0763122840774,-38.9228770483319,-38.7445852497307,-38.5531630405791,-38.3554613519625,-38.1519076449032,-37.9410738079605,-37.7243051665534,-37.5037401051205,-37.2831803863271,-37.0663479589405,-36.8595754218282,-36.6757245355198,-36.5437485832905;-41.1304563127709,-39.2308076386632,-38.1745562313090,-37.6095808626032,-37.2348256747349,-36.9417049126678,-36.6841497994460,-36.4405124250108,-36.2025736153953,-35.9677037705929,-35.7370380128325,-35.5127475739160,-35.3003600938828,-35.1123212397623,-34.9776903602581;-41.5379819763026,-41.2742119183519,-40.4840037964211,-38.4248649626772,-37.1018338944556,-36.3152731431031,-35.7788114597095,-35.3657810513031,-35.0184053603167,-34.7091187368517,-34.4256025745732,-34.1624160932917,-33.9208332214449,-33.7111779547477,-33.5628388654722;-41.4665974984840,-41.2062818405068,-40.8007338310817,-39.8891049906059,-37.6722774952862,-36.1561328363622,-35.2072843873394,-34.5437865512967,-34.0345764662198,-33.6151847681085,-33.2534405769652,-32.9326965446571,-32.6479205613190,-32.4062980256446,-32.2376778289740;-41.3948914217263,-41.1350269266085,-40.7316102442187,-40.1980862693993,-39.2458475870850,-36.9904819232320,-35.3455401884441,-34.2592122027071,-33.4767778324854,-32.8714176597262,-32.3774888474784,-31.9595060022117,-31.6017762953426,-31.3061906377321,-31.1033389990677;-41.3228754580175,-41.0635947718350,-40.6597051924346,-40.1274998928320,-39.5445166042741,-38.6467303117887,-36.4143883085919,-34.6792852801292,-33.4775803186258,-32.5867976091817,-31.8899553767406,-31.3227086851328,-30.8530021165648,-30.4746108129550,-30.2192354690680;-41.2508459423809,-40.9921244710537,-40.5876777073204,-40.0542730844424,-39.4745720465163,-38.9173981848871,-38.3443730793612,-37.5062050324441,-35.6683652210081,-34.1023027363872,-32.9252341472519,-32.0047369279188,-31.2700547194548,-30.6957792207423,-30.3161654914431];


%% Solve for J
fprintf('Iterating J...\n')
fprintf('----------------------\n')

for iter = 1:max_iter

    for i_w=1:n_w
        w = w_grid(i_w);
        J(i_w,:) = z_grid - w + beta*((1-delta(w,z_grid)) .* J0(i_w,:)) * P';
    end

    %Compute norm
    norm = max(abs(J(:)-J0(:)));

    %Check convergence
    if norm>eps
        J0=J;   %update J
        if mod(iter, print)==0
            fprintf('Error = %.8f      Iter = %.0f \n',norm, iter)
        end
    else
        fprintf('Solution has been found! \n')
        fprintf('Error = %.8f      Iter = %.0f \n',norm, iter)
        break
    end

end


%% Solve for theta

J(J<0) = eps;
X = ( (k./J).^(-gamma) - 1);
X(X<0) = 0;                     %deal with possible negative numbers raised to a expoent. 
theta = X.^(1/gamma);


%% Solve for W and U
fprintf('----------------------\n')
fprintf('Iterating W and U...\n')
fprintf('----------------------\n')
for iter=1:max_iter

    
    for i_w=1:n_w
        w = w_grid(i_w);
        b = b_grid(i_w);        
        %i_prime = (i_w>1)*floor(i_w/2)+(i_w==1);

        %Solve worker problem
        W(i_w,:) = u(w,0) + beta* ( (1-delta(w,z_grid)).*W0(i_w,:) +  delta(w,z_grid).*U0(i_w,:) ) * P';
        
        %Solve unemployed problem
        %Compute expected value of searching (for each possible wage posted)
        for i=1:n_w         %for each w
            value_search(i,:) = p(theta(i,:)).*W0(i,:) + ...              %search and find a job
                                (1-p(theta(i,:))).*U0(i_w,:);             %search and DON'T find a job
        end
        
        %Maximize over wage posting 
        [opt_search_value, idx_w] = max(value_search);
        policy_wage(i_w,:) = w_grid(idx_w);
        idx_wage(i_w, :) = idx_w;
        
        %Compute expected value of not searching
        no_search = 0.9*U0(i_w,:) + 0.1*U0(1,:);

        %Compute the expected value of searching
        for i_z=1:n_z
            %Compute expected value of searching if UI still holds
            search_UI(i_w, i_z) = p(theta(idx_w(i_z),i_z))*W0(idx_w(i_z),i_z) + (1-p(theta(idx_w(i_z),i_z)))*U0(i_w,i_z);
            
            %Compute expected value of searching if UI expired
            search_low(i_z) = p(theta(idx_wage(1,i_z),i_z))*W0(idx_wage(1,i_z),i_z) + (1-p(theta(idx_wage(1,i_z),i_z)))*U0(1,i_z);
        end
                
        %Compute RHS of the Bellman equation and maximize over s values
        for i_s=1:n_s
            s = s_grid(i_s);
            RHS(i_s, :) = u(b, s) + beta*(lambda(s)*(0.9*search_UI(i_w,:)+0.1*search_low) + (1-lambda(s))*no_search)* P';
        end
        
        [U(i_w,:), idx_s] = max(RHS);
        policy_effort(i_w,:) = s_grid(idx_s);
        
    end

    %Compute norm 
    norm = max( max(abs(W(:)-W0(:))), max(abs(U(:)-U0(:))) );

    %Check convergence
    if norm>eps
        W0 = W; %update W
        U0 = U; %update U
        if mod(iter, print)==0
            fprintf('Error = %.8f      Iter = %.0f \n',norm, iter)
        end
    else
        fprintf('Solution has been found! \n')
        fprintf('Error = %.8f      Iter = %.0f \n',norm, iter)
        break
    end

end
